# 営業資料 Excel自動生成・配置 提案書

## 1. 要件整理

### 出力要件
- **出力ファイル数**: 月次で5ファイル
  - 総括表: 東京支店、福岡支店、長崎支店（3ファイル）
  - 担当者別: 東京支店、福岡支店、長崎支店（実際は総括表と担当者別で分けるか要確認）
- **ファイル形式**: Excel (.xlsx) + グラフ
- **配置先**: `G:\共有ドライブ\06-05_Fiby様⇔タナチョー共有\01_データ分析基盤構築\03_その他資料\営業資料`

### 支店の定義
| 支店名 | 部門コード | 部門名 |
|--------|-----------|--------|
| 東京支店 | 025 | 硝子建材営業部 |
| 福岡支店 | 031 | 福岡硝子建材営業 |
| 長崎支店 | 065 + 066 | 長崎硝子建材営１ + 長崎硝子建材営２（合算） |

### 実行要件
- **タイミング**: 月次バッチ（自動）
- **実行環境**: GCPのみ使用可
- **グラフ**: 固定レイアウト（毎月同じ）
- **デザイン**: 大まかでOK（細かい指定なし）

---

## 2. 方式比較

### A. Python + openpyxl（GCP完結）

**概要**: Cloud Run/Cloud FunctionsでPythonスクリプトを実行し、openpyxlライブラリでExcelファイルを生成

**メリット**:
- GCP内で完結できる
- グラフ・書式の細かい制御が可能
- 既存のパイプライン（BigQuery → GCS）と統合しやすい
- コードで全て管理できるため、バージョン管理が容易

**デメリット**:
- グラフ作成コードが複雑になりがち
- Excel特有の挙動（セル参照、グラフ範囲など）への対応が必要
- openpyxlのグラフ機能に制限がある場合がある

**推奨度**: ★★★★★

---

### B. Google スプレッドシート → Excel変換

**概要**: Google Sheets APIでスプレッドシートを作成・更新し、Export as xlsxでExcel形式に変換

**メリット**:
- Sheets APIでのグラフ作成が比較的容易
- Google Driveとの連携がスムーズ
- スプレッドシート上でデザイン確認しやすい

**デメリット**:
- xlsx変換時にグラフが崩れる可能性がある
- 中間ファイル（スプレッドシート）が増える
- 変換処理が追加で必要

**推奨度**: ★★★☆☆

---

### C. テンプレートExcel + データ差し込み

**概要**: 事前にグラフ設定済みの雛形Excelを用意し、データ部分のみPythonで更新

**メリット**:
- グラフ設定を事前に済ませられる（コードでグラフを作らなくてよい）
- デザイン調整が容易（Excelで直接編集可能）
- グラフはデータ範囲を参照しているため、データ更新で自動反映

**デメリット**:
- テンプレートファイルの管理が必要
- データ範囲（行数）が変わる場合は手動修正が必要
- テンプレート更新時の運用ルールが必要

**推奨度**: ★★★★☆

---

### D. Looker Studio → PDF/画像 → Excel埋め込み

**概要**: Looker Studioでダッシュボード作成し、PDFや画像としてエクスポート後、Excelに埋め込み

**メリット**:
- Looker Studioのグラフが美しい
- BIツールとして継続運用可能
- インタラクティブなダッシュボードも同時に提供可能

**デメリット**:
- Excel形式での出力が困難（画像埋め込みになる）
- 自動化が複雑（Looker StudioのAPI制限）
- グラフがデータと連動しない（静的画像になる）

**推奨度**: ★★☆☆☆

---

## 3. 推奨案: A + C のハイブリッド方式

### アーキテクチャ

```
[テンプレートExcel]          [BigQuery]
  (GCSに保存)                    │
       │                         │
       └─────────┬───────────────┘
                 ↓
        [Cloud Run (Python)]
        ├─ openpyxl でテンプレートを開く
        ├─ BigQueryからデータ取得
        ├─ データ範囲を更新
        └─ グラフは事前設定済みなので自動反映
                 │
                 ↓
        [Google Drive API]
        └─ 共有ドライブに配置
                 │
                 ↓
    G:\共有ドライブ\06-05_Fiby様⇔タナチョー共有\
    01_データ分析基盤構築\03_その他資料\営業資料\
        ├─ 202509_総括表_東京支店.xlsx
        ├─ 202509_総括表_福岡支店.xlsx
        ├─ 202509_総括表_長崎支店.xlsx
        ├─ 202509_担当者別_東京支店.xlsx
        └─ ...
```

### この方式の利点

1. **テンプレートでグラフ・書式を事前設定**
   - デザイン調整はExcelで直接行える
   - グラフの種類・色・レイアウトを自由に設定可能
   - 非エンジニアでもテンプレート修正が可能

2. **Pythonでデータ差し込み**
   - 既存パイプラインと統合しやすい
   - BigQueryとの連携が容易
   - エラーハンドリング・ログ出力が可能

3. **GCP完結**
   - Cloud Scheduler + Cloud Run で月次自動実行
   - 既存のインフラを活用
   - 運用コストを抑えられる

4. **柔軟性**
   - 将来の要件変更にも対応しやすい
   - テンプレート差し替えでデザイン変更可能

---

## 4. 実装ステップ（概算）

### Phase 1: テンプレート作成
- [ ] 総括表テンプレートExcel作成（グラフ設定込み）
- [ ] 担当者別テンプレートExcel作成（グラフ設定込み）
- [ ] テンプレートをGCSにアップロード

### Phase 2: Python スクリプト開発
- [ ] BigQueryからデータ取得処理
- [ ] openpyxlでテンプレートにデータ差し込み処理
- [ ] Google Drive APIでアップロード処理
- [ ] 支店ごとのファイル生成ループ処理

### Phase 3: GCPデプロイ
- [ ] Cloud Run にデプロイ
- [ ] Cloud Scheduler で月次スケジュール設定
- [ ] サービスアカウント権限設定（Drive API用）

### Phase 4: テスト・運用開始
- [ ] テスト実行・出力確認
- [ ] エラー時の通知設定
- [ ] 運用ドキュメント作成

---

## 5. 検討事項・確認事項

### 要確認
1. **ファイル命名規則**: `YYYYMM_総括表_東京支店.xlsx` のような形式でよいか？
2. **フォルダ構成**: 月ごとにサブフォルダを作るか、フラットに配置するか？
3. **総括表と担当者別**: 別ファイルか、1ファイル内の別シートか？
4. **グラフの種類**: 棒グラフ、折れ線グラフ、円グラフなど、どのようなグラフが必要か？
5. **過去データの扱い**: 毎月上書きか、月ごとにファイルを残すか？

### 技術的検討
1. **Google Drive 共有ドライブへのアクセス**
   - サービスアカウントに共有ドライブへの書き込み権限が必要
   - ドメイン全体の委任設定が必要な場合あり

2. **テンプレートのデータ範囲**
   - 担当者数が月によって変動する場合の対応方法
   - 動的にグラフ範囲を調整するか、最大行数を固定するか

---

## 6. 代替案との比較まとめ

| 評価項目 | A. Python+openpyxl | B. Sheets→xlsx | C. テンプレート方式 | D. Looker Studio |
|----------|-------------------|----------------|-------------------|------------------|
| GCP完結 | ○ | ○ | ○ | △ |
| グラフ品質 | ○ | △ | ◎ | ◎ |
| 開発工数 | 中 | 中 | 小 | 大 |
| 保守性 | ○ | ○ | ◎ | △ |
| Excel出力 | ◎ | △ | ◎ | × |
| 自動化容易性 | ◎ | ○ | ◎ | △ |

**結論**: **A + C のハイブリッド方式（テンプレート + Python差し込み）** を推奨

---

*作成日: 2025-12-09*
*作成者: Claude Code*
