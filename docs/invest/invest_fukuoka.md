# 福岡支店 DataMart実装調査

## 📊 アウトプットイメージ

スクリーンショットより、福岡支店の経営資料は以下の階層構造:

### 組織階層
```
福岡支店計
├─ 工事部計
│  ├─ 硝子工事
│  ├─ ビルサッシ
│  └─ 内装工事
├─ 硝子樹脂計
│  ├─ 硝子
│  ├─ 建材
│  └─ 樹脂
├─ GSセンター
└─ 福北センター
```

### 表示項目
各組織について以下の損益項目を表示:
- 売上高 (前年実績、本年目標、本年実績)
- 売上総利益 (前年実績、本年目標、本年実績)
- 売上総利益率 (前年実績、本年目標、本年実績)
- 営業経費 (前年実績、本年目標、本年実績)
- 営業利益 (前年実績、本年目標、本年実績)
- 営業外収入 (リベート、その他)
- 営業外費用 (社内利息A・B、雑損失)
- 本店管理費
- 経常利益 (本年目標、本年実績、累積本年目標、累積本年実績)

---

## 📋 データソース仕様

### 1. 売上高・売上総利益 (本年実績)

**データソース**: #1 全支店[1.売上管理] 担当者売上目標／実績データ

**フィルタ条件**:
- A列「売上計上月度」= 作成月の前月

**組織別コード割当**:

#### 工事部門
- **工事部計** = 硝子工事 + ビルサッシ + 内装工事

- **硝子工事**:
  - 営業所コード = "030"
  - 部門コード = "010" または "011"

- **ビルサッシ**:
  - 営業所コード = "030"
  - 部門コード = "021"

- **内装工事**:
  - 営業所コード = "034"

#### 硝子樹脂部門
- **硝子樹脂計** = 硝子 + 建材 + 樹脂

- **硝子**:
  - 営業所コード = "031"
  - 部門コード = "010" または "011"

- **建材**:
  - 営業所コード = "031"
  - 部門コード ≠ ("010", "011", "030", "031")

- **樹脂**:
  - 営業所コード = "031"
  - 部門コード = "030" または "031"

#### その他部門
- **GSセンター**: スプレッドシートで手入力運用

- **福北センター**:
  - 営業所コード = "037"

**カラム使用**:
- M列「売上実績」→ 売上高
- O列「粗利実績」→ 売上総利益

**注意事項**:
- 在庫損益の計上: 半年に1回、決算対応後に在庫損益を粗利額に加減算
  - 在庫損益プラス → 粗利額に加算
  - 在庫損益マイナス → 粗利額から減算
  - スプレッドシートから入力してもらう想定

---

### 2. 売上高・売上総利益 (前年実績)

**データソース**: #11 損益4期実績 (福岡支店シート)

**フィルタ条件**:
- A列「期間」= 作成月の前月
- B列「項目」= "売上高" または "売上総利益"

**処理**:
- 1行目C列以降の値が一致したものを代入
- 千円単位→円単位に変換してDB登録、表示は千円単位

**注意事項**:
- 過去データもTKSデータから取得・計算してDBへ登録したい
- **福北センターのみ過去データから算出不可** → 別途データを投入する必要あり (実装方法は別途相談)

---

### 3. 売上高・売上総利益 (本年目標)

**データソース**: #12 損益5期目標 (福岡支店シート)

**フィルタ条件**:
- A列「期間」= 作成月の前月
- B列「項目」= "売上高" または "売上総利益"

**処理**:
- 1行目C列以降の値が一致したものを代入
- 千円単位→円単位に変換してDB登録、表示は千円単位

---

### 4. 売上総利益率

**計算ロジック**:
- 前年実績: 売上総利益の前年実績 ÷ 売上高の前年実績
- 本年目標: 売上総利益の本年目標 ÷ 売上高の本年目標
- 本年実績: 売上総利益の本年実績 ÷ 売上高の本年実績

※各列ごとに計算

---

### 5. 営業経費 (前年実績・本年目標)

**前年実績**:
- データソース: #11 損益4期実績 (福岡支店シート)
- 項目: "営業経費"

**本年目標**:
- データソース: #12 損益5期目標 (福岡支店シート)
- 項目: "営業経費"

---

### 6. 営業経費 (本年実績)

**データソース**: #6 部門集計表

**福岡支店計**: 工事部計 + 硝子樹脂計 + GSセンター + 福北センター

**対象コード**:
```
8331, 8333, 8334, 8335, 8338, 8340, 8341, 8342, 8343, 8344, 8345, 8346, 8347,
8349, 8350, 8351, 8352, 8353, 8354, 8355, 8356, 8357, 8358, 8359, 8361
```

#### 工事部計
- 1行目の値 = 「工事営業部」または「施工」
- A列「コード」が上記対象コードに一致
- **業務部門の費用を案分** (#10 案分比率マスタ参照)

#### 硝子樹脂計
- 1行目の値 = 「硝子建材」または「樹脂」
- A列「コード」が上記対象コードに一致
- **業務部門の費用を案分** (#10 案分比率マスタ参照)

#### GSセンター
- 1行目の値 = 「GS」
- A列「コード」が上記対象コードに一致
- **業務部門の費用を案分** (#10 案分比率マスタ参照)

#### 福北センター
- 8行目の値 = 「福北（大和ハウス硝子）」、「福北（大和ハウス溶接）」、「福北（大和ハウス支店）」、「福北（ナガワ）」、「福北（諸口）」、「福北（テクノ）」、「福北（共通）」(いずれか)
- A列「コード」が上記対象コードに一致
- **業務部門の費用を案分** (#10 案分比率マスタ参照)
- **※5期は案分比率0%**

---

### 7. 営業利益

**計算ロジック**:
- 前年実績: 売上総利益の前年実績 - 営業経費の前年実績
- 本年目標: 売上総利益の本年目標 - 営業経費の本年目標
- 本年実績: 売上総利益の本年実績 - 営業経費の本年実績

※各列ごとに計算

---

### 8. 営業外収入

**データソース**: #4 元帳_雑収入

**部門コード割当**:
- 工事部: R列「自部門コード」= "31"
- 樹脂: R列「自部門コード」= "34"
- GSセンター: R列「自部門コード」= "38"
- 福北センター: R列「自部門コード」= "40", "41", "42", "43", "44", "45", "46"

#### リベート
- V列「摘要」に "リベート" が含まれる (全角・半角両方判定)
- AD列の値を利用
- 税込みの場合、税抜きへ計算が必要

#### その他
- V列「摘要」に "リベート" が含まれない
- AD列の値を利用
- 税込みの場合、税抜きへ計算が必要

**集計**:
- 福岡支店計 = 工事部計 + 硝子樹脂計 + GSセンター + 福北センター
- 硝子樹脂計 = 硝子 + 樹脂

---

### 9. 営業外費用 (社内利息A・B)

**データソース**:
- #3 請求残高一覧表（月間）
- #7 社内金利計算表
- #9 在庫
- #10 案分比率マスタ

**計算式**: `①×②＋③×④＋⑤/⑥×⑤×⑦(%) ＋⑧×⑨(%)`

#### 工事部計
1. **売掛金(①)**: #3で年月が実行月の2か月前 かつ 営業所コード="030" or "034" のD列の値
   - 半期に一度、前受け金を加算 (スプレッドシート手入力、実装方法は別途相談)

2. **売掛金利率(②)**: #7で福岡支店 かつ 分類="社内利息（A）" かつ 内訳="売掛金・工事・第2工事" のE列

3. **未落手形(③)**: #3で年月が実行月の2か月前 かつ 営業所コード="030" or "034" のE列

4. **未落手形利率(④)**: #7で福岡支店 かつ 分類="社内利息（A）" かつ 内訳="未決済手形" のE列

5. **在庫・未成工事(全部署)(⑤)**: #9で支店="福岡" かつ 種別="未成工事在庫" のD列
   - 年月は実行日の2か月前

6. **在庫・未成工事(工事部)(⑥)**: #9で支店="福岡" かつ 部署="工事","ビル","内装工事" かつ 種別="未成工事在庫" のD列

7. **在庫利率(⑦)**: #7で福岡支店 かつ 分類="社内利息（A）" かつ 内訳="棚卸在庫・未成工事支出金" のE列

8. **土地・建物・償却資産利息(⑧)**: #7で福岡支店 かつ 分類="社内利息（A）" かつ 内訳="土地","建物","償却資産" のF列

9. **案分比率(⑨)**: #10で支店="福岡支店" かつ 部署="工事" かつ 種別="社内利息案分" のD列案分比率

#### 硝子樹脂計
- 工事部の条件を硝子建材に変更したもの
- 半期に一度の前受け金も考慮 (スプレッドシート入力、別途相談)

**注意**: 長崎支店と若干異なるため、30分程度の打合せで詳細を確認したい

---

### 10. 営業外費用 (雑損失)

**データソース**: #6 部門集計表

**対象**: コード = "8730"

**集計**:
- **福岡支店計** = 工事部計 + 硝子樹脂計

- **工事部計** = 61「工事部」+ 63「業務部」を案分 (#10案分比率マスタ参照)

- **硝子樹脂計** = 62「建材部」+ 63「業務部」を案分 (#10案分比率マスタ参照)

---

### 11. 本店管理費

**データソース**: #6 部門集計表

**対象**: コード = "8366"

**集計**:
- **福岡支店計** = 工事部計 + 硝子樹脂計

- **工事部計** = 31「工事営業部」の値

- **硝子樹脂計** = 33「硝子建材」+ 34「樹脂」の値

---

### 12. 経常利益

**本年目標**:
- データソース: #12 損益5期目標 (福岡支店シート)
- A列「期間」= 作成月の前月
- B列「項目」= "経常利益"

**本年実績**:
- 計算式: 営業利益の本年実績 + 営業外収入(リベート) + 営業外収入(その他) - 営業外費用 - 本店管理費

**累積本年目標・累積本年実績**:
- 期首からの累計額

---

## 🔍 東京・長崎支店との主な違い

### 1. 組織構造の違い
- **福岡**: 工事部 / 硝子樹脂 / GSセンター / 福北センター
- **長崎**: 工事営業部 / 硝子建材営業部
- **東京**: 工事営業部 / 硝子建材営業部 (担当者別)

### 2. 営業所コードの違い
- **福岡**: 030(工事), 031(硝子樹脂), 034(内装), 037(福北)
- **長崎**: 061(工事), 065/066(硝子建材)
- **東京**: 011(工事), 025(硝子建材)

### 3. 特殊な部門
- **GSセンター**: 売上はスプレッドシートで手入力運用
- **福北センター**: 前年実績データが過去から算出不可 → 別途データ投入が必要

### 4. 社内利息の計算
- 福岡は長崎と若干異なるロジック
- 詳細は30分程度の打合せで確認予定

### 5. 営業経費の部門集計
- 福岡は8行目の値で「福北（XX）」という複数の識別子を使用
- 福北センターの業務部案分比率は5期は0%

---

## ⚠️ 実装上の注意点・相談事項

### 1. 手入力運用が必要な項目
- GSセンターの売上・粗利
- 在庫損益 (半年に1回)
- 前受け金 (半期に1回、社内利息計算用)

### 2. データ制約
- 福北センターの前年実績: 過去データから算出不可 → 別途データ投入方法を相談

### 3. 過去データの取得
- 前年実績値について、過去データもTKSデータから取得・計算してDB登録したい
- 実装方法は別途相談

### 4. 社内利息の詳細ロジック
- 長崎支店と若干異なるため、30分程度の打合せで詳細確認が必要

### 5. 組織構造の将来変更
- 硝子・樹脂部門は統合する予定 → ロジックも若干変更になる予定

---

## 📝 次のステップ

1. 実装方針の決定 (選択肢①/②/③)
2. 不明点の洗い出し (question_fukuoka.md)
3. DWHテーブル設計
4. DataMart SQL作成
5. 手入力データの連携方法検討
