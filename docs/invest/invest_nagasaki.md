# 長崎支店 経営資料（当月）DataMart生成方針

## 1. 概要

長崎支店向けの経営資料（当月）レポートを生成するためのDataMart設計方針をまとめる。

### 1.1 レポート構造
- **データ形式**: 売上系メトリクス × 組織軸 × 値（前年実績/本年目標/本年実績/比率等）
- **対象組織**: 長崎支店配下の工事営業部・硝子建材営業部
- **出力イメージ**: `/Users/oharayousuke/Desktop/Screenshot/スクリーンショット 2025-11-06 11.30.11.png`

### 1.2 メトリクス構成（東京支店と同一）
1. **売上高** - 前年実績、本年目標、本年実績
2. **売上総利益** - 前年実績、本年目標、本年実績
3. **売上総利益率** - 前年実績、本年目標、本年実績、前年比(%), 目標比(%)
4. **営業経費** - 前年実績、本年目標、本年実績
5. **営業利益** - 前年実績、本年目標、本年実績
6. **営業外収入（リベート）** - 本年実績のみ
7. **営業外収入（その他）** - （営業外収入合計 - リベート）
8. **営業外費用（社内利息）** - 本年実績のみ
9. **雑損失（その他）** - 本年実績のみ
10. **本店管理費** - 本年実績のみ
11. **経常利益** - 本年目標、本年実績

---

## 2. 組織構造

### 2.1 長崎支店の組織階層
```
長崎支店計
├── 工事営業部計
│   ├── ガラス工事
│   └── ビルサッシ
└── 硝子建材営業部計
    ├── 硝子工事
    ├── サッシ工事
    ├── 硝子販売
    ├── サッシ販売
    └── 完成品（その他）
```

### 2.2 営業所コードと部門コードのマッピング

#### 工事営業部（営業所コード: 061）
- **ガラス工事**: 営業所コード=061 AND 部門コード=011
- **ビルサッシ**: 営業所コード=061 AND 部門コード=021

#### 硝子建材営業部（営業所コード: 065, 066）
- **硝子工事**: 営業所コード IN (065, 066) AND 部門コード=011
- **サッシ工事**: 営業所コード IN (065, 066) AND 部門コード=021
- **硝子販売**: 営業所コード IN (065, 066) AND 部門コード=010
- **サッシ販売**: 営業所コード IN (065, 066) AND 部門コード=020
- **完成品（その他）**: 営業所コード IN (065, 066) AND 部門コード NOT IN (011, 021, 010, 020)

**注意**: 硝子・樹脂部門は統合予定のため、ロジックも若干変更になる可能性がある

---

## 3. データソースと取得ロジック

### 3.1 売上高

| カテゴリ | データソース | 抽出条件 | 備考 |
|---------|-------------|---------|------|
| 前年実績 | #11 損益4期実績（長崎支店シート） | 期間=対象月の前月 AND 項目="売上高" | 千円単位→円単位に変換してDB登録 |
| 本年目標 | #12 損益5期目標（長崎支店シート） | 期間=対象月の前月 AND 項目="売上高" | 千円単位→円単位に変換してDB登録 |
| 本年実績 | #1 担当者売上目標／実績データ | 売上計上月度=対象月の前月 AND M列「売上実績」 | 営業所コード・部門コードでフィルタ |

### 3.2 売上総利益

| カテゴリ | データソース | 抽出条件 | 備考 |
|---------|-------------|---------|------|
| 前年実績 | #11 損益4期実績（長崎支店シート） | 期間=対象月の前月 AND 項目="売上総利益" | 千円単位→円単位に変換してDB登録 |
| 本年目標 | #12 損益5期目標（長崎支店シート） | 期間=対象月の前月 AND 項目="売上総利益" | 千円単位→円単位に変換してDB登録 |
| 本年実績 | #1 担当者売上目標／実績データ | 売上計上月度=対象月の前月 AND O列「粗利実績」 | 営業所コード・部門コードでフィルタ |

**在庫損益の計上（半期に1回）**:
- 在庫損益がプラス → 粗利額に足す
- 在庫損益がマイナス → 粗利額から引く
- 在庫損益はスプレッドシートから手入力する想定（東京支店と同様）

### 3.3 売上総利益率

計算式による算出（データソース不要）:
- **前年実績**: 売上総利益の前年実績 ÷ 売上高の前年実績
- **本年目標**: 売上総利益の本年目標 ÷ 売上高の本年目標
- **本年実績**: 売上総利益の本年実績 ÷ 売上高の本年実績
- **前年比(%)**: (本年実績 - 前年実績) ÷ 前年実績 × 100
- **目標比(%)**: (本年実績 - 本年目標) ÷ 本年目標 × 100

※各組織列ごとに個別計算

### 3.4 営業経費

| カテゴリ | データソース | 抽出条件 | 備考 |
|---------|-------------|---------|------|
| 前年実績 | #11 損益4期実績（長崎支店シート） | 期間=対象月の前月 AND 項目="営業経費" | 千円単位→円単位に変換してDB登録 |
| 本年目標 | #12 損益5期目標（長崎支店シート） | 期間=対象月の前月 AND 項目="営業経費" | 千円単位→円単位に変換してDB登録 |
| 本年実績（長崎支店計） | - | 工事営業部計 + 硝子建材営業部計 | 計算式 |
| 本年実績（各部門） | #6 部門集計表 + #10 案分比率マスタ | コード=下記の営業経費コード + 業務部門を案分 | 部門別に集計後、業務部を案分 |

**営業経費コード一覧**:
```
8331, 8333, 8334, 8335, 8338, 8340, 8341, 8342, 8343, 8344, 8345,
8346, 8347, 8348, 8349, 8350, 8351, 8352, 8353, 8354, 8355, 8356,
8357, 8358, 8359, 8361
```

**業務部門の案分ロジック**:
- **工事営業部計** = 61「工事部」の値 + 63「業務部」の値 × 案分比率（工事）
- **硝子建材営業部計** = 62「建材部」の値 + 63「業務部」の値 × 案分比率（建材）
- 案分比率は #10 案分比率マスタの「長崎支店、業務部門案分比率」を参照

### 3.5 営業利益

計算式による算出（データソース不要）:
- **前年実績**: 売上総利益の前年実績 - 営業経費の前年実績
- **本年目標**: 売上総利益の本年目標 - 営業経費の本年目標
- **本年実績**: 売上総利益の本年実績 - 営業経費の本年実績

※各組織列ごとに個別計算

### 3.6 営業外収入（リベート）

| カテゴリ | データソース | 抽出条件 | 備考 |
|---------|-------------|---------|------|
| 本年実績 | #6 部門集計表 | コード="8730" | 部門別（61, 62, 63）に集計 + 業務部を案分 |

**業務部門の案分ロジック**:
- **工事営業部計** = 61「工事部」の値 + 63「業務部」の値 × 案分比率（工事）
- **硝子建材営業部計** = 62「建材部」の値 + 63「業務部」の値 × 案分比率（建材）

### 3.7 雑損失（その他）

| カテゴリ | データソース | 抽出条件 | 備考 |
|---------|-------------|---------|------|
| 本年実績 | #6 部門集計表 | コード="8870" | 営業外収入（リベート）と同じ計算方法 |

### 3.8 営業外費用（社内利息A・B）

**データソース**: #3 請求残高一覧表、#7 社内金利計算表、#9 在庫、#10 案分比率マスタ

**計算式**: ①×②＋③×④＋⑤×⑥＋⑦×⑧（％）＋⑨×⑧（％）

#### 工事営業部の計算要素
| 要素 | データソース | 抽出条件 |
|------|-------------|---------|
| ①売掛金 | #3 請求残高一覧表 | 年月=実行月の2か月前 AND 営業所コード=061 AND F列 |
| ②売掛金利率 | #7 社内金利計算表 | 長崎支店 AND 分類=社内利息（A） AND 内訳=売掛金 AND E列 |
| ③未落手形 | #3 請求残高一覧表 | 年月=実行月の2か月前 AND 営業所コード=061 AND E列 |
| ④未落手形利率 | #7 社内金利計算表 | 長崎支店 AND 分類=社内利息（A） AND 内訳=未決済手形 AND E列 |
| ⑤在庫・未成工事 | #9 在庫 | 支店=長崎 AND 部署=工事 AND 種別 IN (期末未成工事, 当月在庫) AND D列 |
| ⑥在庫利率 | #7 社内金利計算表 | 長崎支店 AND 分類=社内利息（A） AND 内訳=棚卸在庫・未成工事支出金 AND E列 |
| ⑦建物利息 | #7 社内金利計算表 | 長崎支店 AND 分類=社内利息（A） AND 内訳=建物 AND F列 |
| ⑧案分比率 | #10 案分比率マスタ | 支店=長崎 AND 部署=工事 AND 種別=減価償却案分 |
| ⑨償却資産利息 | #7 社内金利計算表 | 長崎支店 AND 分類=社内利息（A） AND 内訳=償却資産 AND F列 |

**注意**:
- 在庫の年月は実行日の2か月前（2か月前のデータを当月連携）
- 半期に1度、前受け金を加算する必要がある（スプレッドシート手入力想定）

#### 硝子建材営業部の計算要素
工事営業部と同じ構造で、下記を変更:
- 営業所コード: 065または066
- 部署: 「工事」→「硝子建材」

### 3.9 本店管理費

| カテゴリ | データソース | 抽出条件 | 備考 |
|---------|-------------|---------|------|
| 本年実績 | #6 部門集計表 | コード="8366" | 部門別（61, 62）で直接集計（業務部の案分なし） |

**集計ロジック**:
- **長崎支店計** = 工事営業部計 + 硝子建材営業部計
- **工事営業部計** = 61「工事部」の値
- **硝子建材営業部計** = 62「建材部」の値

### 3.10 経常利益

| カテゴリ | データソース | 抽出条件 | 備考 |
|---------|-------------|---------|------|
| 本年目標 | #12 損益5期目標（長崎支店シート） | 期間=対象月の前月 AND 項目="経常利益" | 千円単位→円単位に変換してDB登録 |
| 本年実績 | - | 営業利益 + 営業外収入（リベート） + 営業外収入（その他） - 営業外費用 - 本店管理費 | 計算式 |

※各組織列ごとに個別計算

---

## 4. DataMart設計方針

### 4.1 テーブル構造（想定）

基本的に東京支店と同一のカラム構成を採用:

```sql
CREATE TABLE corporate_data_dm.management_documents_nagasaki (
  date DATE NOT NULL,                      -- 対象年月
  main_category STRING NOT NULL,           -- 売上高、売上総利益、営業経費等
  main_category_sort_order INT64,          -- ソート順
  secondary_category STRING NOT NULL,      -- 前年実績(千円)、本年目標(千円)等
  main_department STRING NOT NULL,         -- 長崎支店計
  secondary_department STRING NOT NULL,    -- 工事営業部計、硝子建材営業部計、ガラス工事等
  secondary_department_sort_order INT64,   -- ソート順
  value FLOAT64,                           -- 実際の値（円単位）
  display_value FLOAT64                    -- 表示用の値（千円単位または%）
)
PARTITION BY date
CLUSTER BY main_category, secondary_department;
```

### 4.2 縦持ち変換の考え方

**横持ちデータ（Excel）**:
```
項目       | 長崎支店計 | 工事営業部計 | ガラス工事 | ...
---------- | --------- | ----------- | --------- | ---
売上高      | 100,000   | 60,000      | 40,000    | ...
```

**縦持ちデータ（DataMart）**:
```
main_category | secondary_category | main_department | secondary_department | value
------------- | ------------------ | --------------- | -------------------- | -------
売上高         | 前年実績(千円)      | 長崎支店計       | 長崎支店計            | 100000
売上高         | 前年実績(千円)      | 長崎支店計       | 工事営業部計          | 60000
売上高         | 前年実績(千円)      | 長崎支店計       | ガラス工事            | 40000
```

### 4.3 生成フロー

```
[Raw Data Sources]
    ↓
[DWH Layer (corporate_data_dwh)]
    ├── dwh_sales_actual_nagasaki (営業所コード061, 065, 066でフィルタ)
    ├── dwh_sales_target_nagasaki (長崎支店シートから抽出)
    ├── operating_expenses_nagasaki (部門集計表から抽出)
    └── ... (その他の指標)
    ↓
[DataMart Layer (corporate_data_dm)]
    └── management_documents_nagasaki
        ├── 売上高（前年実績、本年目標、本年実績）
        ├── 売上総利益（前年実績、本年目標、本年実績）
        ├── 売上総利益率（計算）
        ├── 営業経費（前年実績、本年目標、本年実績）
        ├── 営業利益（計算）
        ├── 営業外収入・費用
        ├── 本店管理費
        └── 経常利益
```

---

## 5. データ品質要件

### 5.1 単位変換
- **入力**: 千円単位（Excel損益計画）
- **DB保存**: 円単位（INTEGER型）
- **表示**: 千円単位（FLOAT型、小数点以下切り捨て）
- **利益率**: %表示（小数点第1位まで）

### 5.2 計算精度
- 利益率計算: ゼロ除算エラーのハンドリング（売上高=0の場合）
- 比率計算: ROUND(value, 1) で小数点第1位まで
- 千円表示: CAST(value / 1000 AS INT64) で整数化

### 5.3 NULL値の扱い
- 前年実績がない場合: NULL（0ではなくNULLで表現）
- 計算結果がNULLの場合: 比率は計算不可として NULL
- 表示時: NULL → "-" または空白

---

## 6. 東京支店との差異

### 6.1 組織構造の違い

| 項目 | 東京支店 | 長崎支店 |
|------|---------|---------|
| 営業所コード | 011, 013, 025 | 061, 065, 066 |
| 主要部門 | 工事営業部、硝子建材営業部 | 工事営業部、硝子建材営業部 |
| 細分化 | 佐々木、浅井、小笠原、高石、山本 | ガラス工事、ビルサッシ、硝子工事、サッシ工事等 |

### 6.2 データソースの違い

| データ | 東京支店 | 長崎支店 |
|--------|---------|---------|
| 損益実績 | 損益4期実績（東京支店シート） | 損益4期実績（長崎支店シート） |
| 損益目標 | 損益5期目標（東京支店シート） | 損益5期目標（長崎支店シート） |
| 売上実績 | #1 担当者売上（営業所011, 013, 025） | #1 担当者売上（営業所061, 065, 066） |

### 6.3 業務部門案分の違い

長崎支店特有の案分ロジック:
- 業務部（63）の費用を工事・建材に案分
- 案分比率は #10 案分比率マスタから取得
- 本店管理費は案分なし（直接割当）

---

## 7. 実装上の考慮事項

### 7.1 今後の変更予定
- **硝子・樹脂部門の統合**: 組織コードとロジックが変更になる可能性
- **前年実績の過去データ取得**: TKSデータから取得・計算する方法を検討
- **在庫損益の入力**: スプレッドシートから手入力する仕組みを整備
- **前受け金の入力**: 半期に1度、スプレッドシートから手入力する仕組みを整備

### 7.2 データ連携タイミング
- **月次更新**: 毎月初旬（前月データが確定後）
- **在庫データ**: 2か月前のデータを当月連携（タイムラグあり）
- **半期更新**: 在庫損益、前受け金を追加計上

### 7.3 エラーハンドリング
- 営業所コード・部門コードの存在チェック
- データソースファイルの欠損チェック
- 計算結果の異常値チェック（負の売上高等）
- ログ出力とアラート通知

---

## 8. 次のステップ

1. **東京支店DWH/DMとの比較調査** (invest_nagasaki_and_tokyo.md)
   - 同一テーブルに長崎データを追加できるか
   - DWH/DMを完全分離すべきか
   - 長崎専用DWHが必要か

2. **サンプルデータでの検証**
   - 実際の損益計画Excelから少量データを抽出
   - 計算ロジックの正確性を検証

3. **ETLパイプラインの実装**
   - Cloud Functions / Cloud Run での処理
   - BigQuery SQLの作成

4. **Looker Studioダッシュボードの作成**
   - 東京支店と同様のレイアウト
   - 長崎支店の組織構造に対応
