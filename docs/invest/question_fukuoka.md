# 福岡支店 DataMart実装 - 質問・不明点リスト

## ❓ データソースに関する質問

### 1. GSセンターの売上・粗利データ
**質問**: GSセンターの売上・粗利はスプレッドシートで手入力運用とのことですが、具体的なフローは?

**現状の理解**:
- #1 sales_target_and_achievements には GSセンター のデータが含まれていない
- スプレッドシートで入力してもらう必要がある

**実装への影響**:
- GSセンター用の専用テーブルが必要か?
- または、既存の`sales_target_and_achievements`に手入力データをマージする形か?
- データ投入のタイミングは?

**提案**:
- `gs_center_manual_input` テーブルを作成
- スプレッドシート→BigQueryへのデータ連携パイプライン構築
- `dwh_sales_actual_fukuoka` SQLで LEFT JOIN して統合

---

### 2. 福北センターの前年実績データ
**質問**: 「福北センターのみ過去データから算出不可」とのことですが、どのように対応すべきか?

**現状の理解**:
- #11 損益4期実績には福北センターのデータがない、または不完全
- 別途データを投入する必要がある

**実装への影響**:
- 前年実績テーブル `dwh_sales_actual_prev_year_fukuoka` の作成方法
- 福北センターだけ別テーブルにするか?
- データ投入の頻度・タイミングは?

**提案**:
- 過渡期の対応として、福北センターは前年実績=NULLまたは0で実装
- 手動でデータ投入するための専用テーブル `fukuhoku_prev_year_manual` を作成
- 中長期的には、過去データの整備を検討

---

### 3. 在庫損益の半年1回計上
**質問**: 在庫損益の計上方法の詳細は?

**現状の理解**:
- 半年に1回、決算対応後に在庫損益を粗利額に加減算
- 在庫損益プラス → 粗利額に加算
- 在庫損益マイナス → 粗利額から減算
- スプレッドシートから入力してもらう想定

**実装への影響**:
- 在庫損益データの格納テーブルが必要
- `dwh_sales_actual_fukuoka` の粗利額に加減算するタイミング
- 対象月の識別方法 (半年に1回 = 3月・9月?)

**提案**:
- `inventory_pnl_fukuoka` テーブル作成 (year_month, organization, detail_category, pnl_amount)
- `dwh_sales_actual_fukuoka` SQLで LEFT JOIN して粗利額に加減算
- 対象月のみデータが存在する形

---

### 4. 半期に1回の前受け金 (社内利息計算用)
**質問**: 前受け金の入力・計算方法の詳細は?

**現状の理解**:
- 社内利息A・Bの計算時、半期に1回だけ前受け金を加算
- スプレッドシートで手入力

**実装への影響**:
- 前受け金データの格納方法
- 社内利息計算SQLへの統合方法
- 対象月の識別

**提案**:
- 社内利息の実装は優先度を下げて、まずは基本データの実装を先行
- 詳細は30分の打合せで確認してから設計

---

## 🔍 ロジックに関する質問

### 5. 社内利息A・Bの計算ロジック
**質問**: 長崎支店と福岡支店で社内利息のロジックが「若干異なる」とのことですが、具体的な差分は?

**現状の理解**:
- 基本的な計算式は同じ: `①×②＋③×④＋⑤/⑥×⑤×⑦(%) ＋⑧×⑨(%)`
- 「30分程度の打合せで詳細を確認したい」とのこと

**実装への影響**:
- 長崎版SQLを流用できるか、新規作成が必要か判断できない
- 複雑度が高い場合、実装優先度を下げる必要がある

**提案**:
- まず打合せで差分を明確化
- 差分が小さければ、長崎版SQLを修正して対応
- 差分が大きければ、福岡専用SQLを新規作成
- 当面は社内利息を除外してDataMart構築し、後から追加

---

### 6. 部門集計表の識別方法
**質問**: #6 部門集計表で福岡の部門を識別する方法は?

**現状の理解**:
- 営業経費: 1行目の値が「工事営業部」「施工」「硝子建材」「樹脂」「GS」
- 福北センター: 8行目の値が「福北（XX）」という複数パターン

**不明点**:
- 1行目・8行目の値は、列方向のヘッダーなのか、行方向の識別子なのか?
- 実際のデータ構造を確認する必要がある
- 福北センターの「福北（大和ハウス硝子）」等、全パターンのリストは完全か?

**提案**:
- `#6 部門集計表` の実データサンプルを確認
- 福岡支店に関するデータがどのように格納されているか確認
- 必要に応じてSQL調整

---

### 7. 営業所コードと部門コードの組み合わせ
**質問**: 仕様書に記載の組み合わせは網羅的か?

**現状の理解**:
```
硝子工事: 営業所030 + 部門010/011
ビルサッシ: 営業所030 + 部門021
内装工事: 営業所034
硝子: 営業所031 + 部門010/011
建材: 営業所031 + 部門010/011/030/031以外
樹脂: 営業所031 + 部門030/031
福北センター: 営業所037
```

**不明点**:
- 上記以外の組み合わせは存在しないか? (例: 営業所030 + 部門999 など)
- **営業所032 (福岡樹脂営業) が実データに存在するが、仕様書に記載がない**
  - 実データ: 営業所032「福岡樹脂営業」が13行存在 (2025-09-01)
  - 仕様書では営業所031に樹脂が含まれる想定
  - 032は031に統合されるべきか? または別カテゴリとして扱うべきか?
  - 「硝子・樹脂部門は統合する予定」との記載と関連があるか?
- 「その他」カテゴリへの振り分けロジックで問題ないか?
- 実データで想定外のパターンが出た場合の対処

**提案**:
- 実データで営業所コードと部門コードの全組み合わせを確認
- **営業所032の扱いを明確化**:
  - オプション1: 営業所031と統合して「樹脂」カテゴリに含める
  - オプション2: 別カテゴリ「福岡樹脂営業」として扱う
  - オプション3: 当面は「その他」に振り分け、将来的に統合
- 想定外パターンが出た場合は「その他」または「未分類」カテゴリに振り分け
- 定期的にモニタリングして想定外データを検出

---

## 📊 DataMart設計に関する質問

### 8. 組織階層の表現方法
**質問**: 福岡支店の組織階層をどのように表現すべきか?

**現状の理解**:
```
福岡支店計
├─ 工事部計 (硝子工事 + ビルサッシ + 内装工事)
├─ 硝子樹脂計 (硝子 + 建材 + 樹脂)
├─ GSセンター
└─ 福北センター
```

**不明点**:
- 「工事部計」と「硝子樹脂計」は、実データとしてdwh_sales_actualに含めるか、DataMart側で集計するか?
- 東京・長崎と同様、detail_categoryに「工事部計」「硝子樹脂計」を含めるか?

**提案**:
- DWHレベルでは詳細レベル(硝子工事、ビルサッシ等)のみを保持
- 「工事部計」「硝子樹脂計」「福岡支店計」はDataMart SQLで集計して生成
- これにより、東京・長崎と一貫した設計になる

---

### 9. 硝子樹脂部門の将来的な統合
**質問**: 「硝子・樹脂部門は統合する予定」とのことですが、スケジュールは?

**現状の理解**:
- 現在は「硝子樹脂計 = 硝子 + 建材 + 樹脂」の3つに分かれている
- 将来的に統合される予定
- ロジックも若干変更になる予定

**実装への影響**:
- 現時点では3つに分けて実装すべきか?
- または最初から統合した形で実装すべきか?
- 移行期のデータ互換性をどう保つか?

**提案**:
- 現時点では仕様通り、硝子・建材・樹脂の3つに分けて実装
- 将来的な統合は、organizationまたはdetail_categoryのマッピングテーブルで対応
- 過去データとの互換性を維持しながら、表示側で統合できるようにする

---

## 🔧 技術的な質問

### 10. 全角・半角の「リベート」判定
**質問**: 全角・半角両方の「リベート」を判定する実装方法は?

**現状の理解**:
- V列「摘要」に "リベート" が含まれるかチェック
- 全角「リベート」と半角「リベート」の両方に対応が必要

**実装方法**:
```sql
WHERE (
  REGEXP_CONTAINS(description, r'リベート')  -- 全角
  OR REGEXP_CONTAINS(description, r'ﾘﾍﾞｰﾄ')  -- 半角カナ
  OR UPPER(description) LIKE '%REBATE%'     -- 英語も念のため
)
```

**確認事項**:
- 実データで「リベート」の表記ゆれはあるか?
- 大文字・小文字、スペース等のバリエーションは?

---

### 11. 税込み→税抜き計算
**質問**: 営業外収入の税込み→税抜き計算の詳細は?

**現状の理解**:
- 税込みの場合、税抜きへ計算が必要
- 税率は10%? (軽減税率8%のケースは?)
- 税込み/税抜きの判定方法は?

**不明点**:
- データに税込み/税抜きのフラグがあるか?
- または金額から推定するか?
- 過去の税率変更(8% → 10%)への対応は?

**提案**:
- 元帳データに税込み/税抜きフラグまたは税率カラムがあれば使用
- なければ、一律10%で除算 (要確認)
- 過去データは税率マスタを参照して計算

---

## ⚙️ 運用に関する質問

### 12. データ投入のタイミング
**質問**: 各データソースの更新・投入タイミングは?

**現状の理解**:
- 月次で実行する想定
- 「作成月の前月」のデータを取得

**不明点**:
- 各データソース(#1, #6, #11, #12等)の更新タイミングは統一されているか?
- 月初何日までに全データが揃うか?
- 不揃いの場合、どの順序でパイプラインを実行すべきか?

**提案**:
- データソース別の更新スケジュールを整理
- 依存関係を明確化
- 月次バッチ実行の順序を定義

---

### 13. 手入力データの投入方法
**質問**: スプレッドシート手入力データの具体的な投入フローは?

**手入力が必要なデータ**:
1. GSセンターの売上・粗利
2. 在庫損益 (半年に1回)
3. 前受け金 (半期に1回、社内利息計算用)
4. 福北センターの前年実績

**不明点**:
- Google SpreadsheetからBigQueryへの連携方法は?
  - Apps Script? Cloud Functions? 手動エクスポート?
- バリデーションルールは?
- 入力ミス時のエラーハンドリングは?

**提案**:
- Google Spreadsheet → Cloud Storage → BigQuery のパイプライン構築
- Apps Scriptで定型フォーマットをCSV出力
- Cloud Functionsでバリデーション+BigQuery投入
- エラー時は担当者にメール通知

---

## 🎯 実装優先度の確認

### 14. 最初に実装すべき範囲
**質問**: 初回リリースで必須の項目と、後回しで良い項目の切り分けは?

**提案する優先度**:

**優先度1 (必須)**:
- 売上高・売上総利益の本年実績・本年目標
- 売上総利益率
- 営業経費の本年実績・本年目標
- 営業利益

**優先度2 (重要だが後回し可能)**:
- 営業外収入 (リベート・その他)
- 雑損失
- 本店管理費
- 経常利益

**優先度3 (複雑なため要相談)**:
- 売上高・売上総利益の前年実績
- 社内利息A・B
- GSセンター手入力データ連携
- 在庫損益計上

**確認事項**:
- この優先度で問題ないか?
- 初回リリース時点でどこまで実装すべきか?

---

## 📅 次のアクション

### 打合せで確認したい事項 (優先度順)
1. **社内利息A・Bの詳細ロジック** (30分程度)
   - 長崎支店との差分
   - 前受け金の扱い
   - 計算式の詳細

2. **手入力データの運用フロー**
   - GSセンター売上・粗利
   - 在庫損益
   - 前受け金
   - 福北センター前年実績

3. **部門集計表のデータ構造確認**
   - 1行目・8行目の値の意味
   - 福北センターの識別パターン

4. **実装範囲とスケジュール**
   - 初回リリースでどこまで実装するか
   - 段階的なリリース計画

### データ確認が必要な項目
1. sales_target_and_achievements テーブルで福岡の営業所コード(030, 031, 034, 037)のデータ確認
2. department_summary テーブルで福岡支店の部門構造確認
3. ms_allocation_ratio テーブルで福岡の案分比率確認
4. ledger_income テーブルで福岡の部門コード(31, 34, 38, 40-46)のデータ確認
