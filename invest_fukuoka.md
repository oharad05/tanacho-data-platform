# 福岡支店 営業外費用(社内利息A・B) 実装調査

## 組織構造

```
福岡支店計
├─ 工事部計
│   ├─ 硝子工事 (営業所コード=030 & 部門コード=010 or 011)
│   ├─ ビルサッシ (営業所コード=030 & 部門コード=021)
│   └─ 内装工事 (営業所コード=034)
├─ 硝子樹脂部計
│   ├─ 硝子 (営業所コード=031 & 部門コード=010 or 011)
│   ├─ 建材 (営業所コード=031 & 部門コード≠010,011,030,031)
│   ├─ 樹脂 (営業所コード=031 & 部門コード=030 or 031)
│   ├─ GSセンター (スプレッドシート手入力)
│   └─ 福北センター (営業所コード=037)
```

## 長崎支店との主な差分

### 1. 組織構造の違い

| 項目 | 長崎支店 | 福岡支店 |
|------|----------|----------|
| 最上位部門数 | 2つ | 2つ |
| 第1部門名 | 工事営業部計 | 工事部計 |
| 第1部門構成 | 単一集計 | 3つのサブ部門 (硝子工事+ビルサッシ+内装工事) |
| 第2部門名 | 硝子建材営業部計 | 硝子樹脂部計 |
| 第2部門構成 | 単一集計 | 5つのサブ部門 (硝子+建材+樹脂+GSセンター+福北センター) |
| センター | なし | GSセンター、福北センター |

### 2. 営業所コードの違い

**長崎支店:**
- 工事営業部: 061
- 硝子建材営業部: 065, 066

**福岡支店:**
- 工事部:
  - 硝子工事: 030
  - ビルサッシ: 030
  - 内装工事: 034
- 硝子樹脂部:
  - 硝子: 031
  - 建材: 031
  - 樹脂: 031
  - 福北センター: 037
  - GSセンター: 手入力

### 3. データソースの違い

#### 長崎支店:
- **請求残高**: branch_code IN (61, 65, 66)
- **社内金利**: branch = '長崎支店'
- **在庫**: branch = '長崎', department IN ('工事', '硝子建材')
- **案分比率**: branch = '長崎', department IN ('工事', '硝子建材')

#### 福岡支店:
- **請求残高**: branch_code IN (030, 031, 034, 037) ※要確認
- **社内金利**: branch = '福岡支店'
- **在庫**: branch = '福岡', department IN ('工事', '硝子樹脂') ※要確認
- **案分比率**: branch = '福岡', department IN ('工事', '硝子樹脂') ※要確認

## 実装上の課題

### 1. サブ部門レベルの集計

長崎支店は「工事営業部計」「硝子建材営業部計」の2つのみでしたが、福岡支店は:
- 工事部: 3つのサブ部門 (硝子工事、ビルサッシ、内装工事)
- 硝子樹脂部: 5つのサブ部門 (硝子、建材、樹脂、GSセンター、福北センター)

各サブ部門ごとに社内利息を計算する必要があるか、それとも「工事部計」「硝子樹脂部計」のみでよいか確認が必要。

### 2. 営業所コードと部門コードの組み合わせ

福岡支店は、同じ営業所コード(031)内で部門コードによって「硝子」「建材」「樹脂」を区別しています。
請求残高テーブルに部門コード情報があるか確認が必要。

### 3. GSセンターの扱い

仕様書では「スプレッドシートで手入力運用」とされているため、社内利息の計算対象外の可能性があります。

### 4. 「建材」部門の存在確認

仕様書には「硝子+建材+樹脂」と記載されていますが、スクリーンショットでは「建材」列が明確に確認できません。
実装前に組織構造の最終確認が必要です。

## 実装ステップ (案)

### Phase 1: データソース確認
1. 福岡支店の営業所コード一覧を確認
2. 請求残高テーブルに部門コード情報があるか確認
3. 社内金利テーブルの福岡支店データを確認
4. 在庫テーブルの福岡支店データを確認
5. 案分比率テーブルの福岡支店データを確認

### Phase 2: 集計レベルの決定
1. サブ部門レベル(硝子工事、ビルサッシ等)で計算するか
2. 部門レベル(工事部計、硝子樹脂部計)のみで計算するか
3. GSセンター・福北センターを社内利息計算に含めるか

### Phase 3: DWHテーブル作成
- `non_operating_expenses_fukuoka.sql` の作成
- 長崎支店の実装を参考に、福岡支店の営業所コード・部門構造に合わせて調整

### Phase 4: DataMart統合
- `datamart_management_report_fukuoka.sql` の修正
- 統合DataMart (`datamart_management_report_all.sql`) への反映

## 実装結果 (2025-11-14)

### 完了した実装

以下のDWHテーブルに福岡支店のデータを追加しました:

1. **営業外収入 (non_operating_income)**
   - データソース: department_summary (code 8730=リベート, 8870=その他)
   - 集計レベル: 4部門（工事部計、硝子樹脂計、GSセンター、福北センター）
   - 業務部門案分: ms_allocation_ratio (category='業務部門案分')

2. **営業経費 (operating_expenses)**
   - データソース: department_summary (codes 8331-8361)
   - 集計レベル: 4部門
   - 業務部門案分: 実装済み

3. **本社経費 (head_office_expenses)**
   - データソース: department_summary (code 8366)
   - 集計レベル: 4部門
   - 案分なし（各部門の直接費のみ）

4. **雑損失 (miscellaneous_loss)**
   - データソース: department_summary (code 8870)
   - 集計レベル: 4部門
   - 業務部門案分: 実装済み

### 決定事項

1. **集計レベル**: 部門計レベル（工事部計、硝子樹脂計、GSセンター、福北センター）で実装
   - サブ部門（硝子工事、ビルサッシ等）は今回対象外

2. **データソース**: department_summaryの各列を直接使用
   - construction_department → 工事部計
   - glass_building_material_sales_department → 硝子樹脂計
   - gs → GSセンター
   - fukuhoku_* (7列の合計) → 福北センター

3. **案分比率**: ms_allocation_ratioテーブルを使用
   - branch='福岡', category='業務部門案分'
   - department IN ('工事', '硝子建材', '樹脂建材', 'GSセンター')

### 未実装・保留事項

#### 1. 営業外費用（社内利息）
**理由**:
- 東京支店と長崎支店の実装が別ファイルに分離されている
- 福岡支店の在庫データが存在しない（社内利息Bが計算不可）
- 3支店統合の複雑な実装が必要

**対応方針**:
- 別タスクとして実装を保留
- 福岡支店は社内利息A（売掛金・未落手形のみ）の実装が可能だが、在庫がないため優先度低

#### 2. DataMart実装上の課題

**福岡支店固有の構造**:
- 4部門すべてが同じ階層レベル（東京・長崎のような階層構造なし）
- 「福岡支店計」= 4部門の単純合計
- 中間集計（例: ガラス工事計）が存在しない

**DataMart設計方針**:
- 長崎支店のシンプルなパターンをベースにする
- 垂直フォーマット変換で4部門を並列に扱う
- secondary_department_sort_orderで表示順を制御

### データ検証結果

```sql
SELECT branch, detail_category, COUNT(*) as row_count
FROM `data-platform-prod-475201.corporate_data_dwh.operating_expenses`
GROUP BY branch, detail_category
ORDER BY branch, detail_category;
```

結果:
- 福岡支店: 各部門16行（複数月のデータ）
- 東京支店: 各部門2行
- 長崎支店: 各部門2行

## 次のアクション

### 即座に必要な作業
1. ✅ **DWHテーブル更新**: 完了
2. 🔄 **福岡支店DataMart作成**: 作業中
3. ⬜ **統合DataMart作成**: 未着手

### 今後の課題
1. **営業外費用（社内利息）の統合実装**
   - 東京・長崎・福岡を1つのテーブルに統合
   - 福岡は社内利息Aのみ実装

2. **在庫データの確認**
   - 福岡支店の在庫データが存在するか再確認
   - 存在する場合は社内利息Bの実装が可能

3. **サブ部門レベルの売上実績データ確認**
   - 硝子工事、ビルサッシ、内装工事等のサブ部門別売上データの有無確認
   - 存在する場合はより詳細なDataMart実装が可能
