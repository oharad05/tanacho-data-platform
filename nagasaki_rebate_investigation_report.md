# 長崎支店 営業外収入(リベート)が0円になっている原因調査報告

## 調査日
2025年11月13日

## 調査対象
- 対象月: 2025年9月
- 項目: 営業外収入(リベート)
- 支店: 長崎支店

## 結果サマリー
**原因: 文字エンコーディングの不一致**

データソースには「**ﾘﾍﾞｰﾄ**」（半角カタカナ）が含まれているが、SQLの検索パターンは「**リベート**」（全角カタカナ）のみを対象としているため、リベートデータが抽出されていない。

## 詳細調査結果

### 1. データソースの確認

`ledger_income`テーブルに2025年9月のデータが存在することを確認:

```sql
SELECT
  DATE(accounting_month) AS year_month,
  own_department_code,
  description_comment,
  amount
FROM `corporate_data.ledger_income`
WHERE own_department_code IN (61, 62, 63)
  AND DATE(accounting_month) = DATE('2025-09-01')
```

**結果:**
| year_month | own_department_code | description_comment | amount |
|------------|---------------------|---------------------|--------|
| 2025-09-01 | 61 | 財-11　**ﾘﾍﾞｰﾄ**/日本板硝子BP㈱　7月分　三井住友 | 6,961円 |
| 2025-09-01 | 62 | 財-11　**ﾘﾍﾞｰﾄ**/日本板硝子BP㈱　7月分　三井住友 | 23,839円 |

**発見:** リベートデータは存在するが、「**ﾘﾍﾞｰﾄ**」と半角カタカナで記載されている。

### 2. SQLの検索パターン確認

`non_operating_income.sql` (行90, 107)の検索パターン:

```sql
REGEXP_CONTAINS(description_comment, r'リベート|リベート')
```

このパターンは以下のみマッチ:
- ✅ **リベート** (全角カタカナ)
- ❌ **ﾘﾍﾞｰﾄ** (半角カタカナ) ← 実際のデータ

### 3. 影響範囲

**長崎支店のリベート収入が正しく計上されていない:**
- 工事営業部(61): 6,961円 → 0円
- 硝子建材営業部(62): 23,839円 → 0円
- **合計: 30,800円が未計上**

## 解決策

### 修正案: SQLの検索パターンを拡張

**修正前:**
```sql
REGEXP_CONTAINS(description_comment, r'リベート|リベート')
```

**修正後:**
```sql
REGEXP_CONTAINS(description_comment, r'リベート|リベート|ﾘﾍﾞｰﾄ')
```

### 修正対象ファイル

`sql/split_dwh_dm/non_operating_income.sql`
- 行90: 長崎支店 工事営業部のリベート判定
- 行107: 長崎支店 硝子建材営業部のリベート判定
- 行124: 長崎支店 業務部のリベート判定

※東京支店も同様のパターンを使用しているため、合わせて修正推奨:
- 行27, 43, 59: 東京支店の各部門のリベート判定

### 修正後の期待値

2025年9月のリベート収入:
- 工事営業部計: 6,961円
- 硝子建材営業部計: 23,839円
- **長崎支店計: 30,800円**

## 再発防止策

1. **データ投入時の文字エンコーディング統一**
   - TKSデータから取り込む際に、半角カタカナを全角カタカナに変換

2. **SQLパターンの包括的対応**
   - 全角・半角の両方に対応したパターンマッチング
   - 正規表現: `r'リベート|リベート|ﾘﾍﾞｰﾄ'`

3. **データ品質チェックの追加**
   - データ投入後に文字エンコーディングの一貫性を確認

## 次のステップ

1. ✅ **即時対応**: `non_operating_income.sql`の修正
2. ✅ **DWHテーブル再作成**: 修正後のSQLでテーブル更新
3. ✅ **DataMart再作成**: 最新データの反映
4. ⬜ **過去データの修正**: 必要に応じて過去月のデータも再計算
5. ⬜ **データ投入プロセスの改善**: 半角→全角変換処理の追加

## 添付資料

### A. 実際のデータサンプル

```
description_comment: "財-11　ﾘﾍﾞｰﾄ/日本板硝子BP㈱　7月分　三井住友"
                            ↑↑↑↑
                          半角カタカナ
```

### B. 文字コード比較

| 文字種類 | 文字 | Unicode | バイト表現 |
|----------|------|---------|------------|
| 全角カタカナ | リ | U+30EA | E3 83 AA |
| 全角カタカナ | ベ | U+30D9 | E3 83 99 |
| 半角カタカナ | ﾘ | U+FF98 | EF BE 98 |
| 半角カタカナ | ﾍﾞ | U+FF8D U+FF9E | EF BE 8D EF BE 9E |

---

**報告者**: Claude Code
**承認**: [承認者名]
**配布先**: データエンジニアリングチーム、経理部門
